name: Auto Sync Upstream Branch
on:
  schedule:
    - cron: 0 16 * * *
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Sync
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          DATA_FILE="data/auto-sync-upstream-branch.json"
          COUNT=$(jq length "$DATA_FILE")
          for i in $(seq 0 $((COUNT - 1))); do
            SOURCE_URL=$(jq -r ".[$i].source" "$DATA_FILE")
            TARGETS=$(jq -r ".[$i].targets[]" "$DATA_FILE")
            TEMP_DIR=$(mktemp -d)
            git clone --bare "$SOURCE_URL" "$TEMP_DIR"
            cd "$TEMP_DIR"
            echo "$TARGETS" | while read TARGET; do
              git push --all --force "git@github.com:$TARGET.git"
              git push --tags --force "git@github.com:$TARGET.git"
            done
            cd "$GITHUB_WORKSPACE"
            rm -rf "$TEMP_DIR"
          done
